/**
 * WTChessPath - Get possible moves in chess board
 * 
 * @author Anuj Kumar <anujkumar00p@gmail.com>
 * @link https://instagram.com/webcodehindi
 * @link https://github.com/webcodehindi/chesspath
 */
class ChessPath{constructor(t){if("function"!=typeof t)throw Error("First parameter should be a function");this._G_PIECE=t,this._PIECE_SQR1={},this._PIECE_SQR2=[],this._N_MOVES=[],this._M_JUMP={T:8,B:-8,R:1,L:-1,W:7,X:9,Y:-9,Z:-7},this._SQR_H=["A","B","C","D","E","F","G","H"],this._SQR_V=["8","7","6","5","4","3","2","1"],this._PATTERN={K:"T,1=B,1=L,1=R,1=W,1=X,1=Y,1=Z,1",Q:"T=B=L=R=W=X=Y=Z",R:"T=B=L=R",B:"W=X=Y=Z",N:"T,2=B,2=L,2=R,2",BP:"T,2,=W,1=X,1",TP:"B,2,=Y,1=Z,1"},this._SQR_V.forEach(t=>this._SQR_H.forEach(_=>{this._PIECE_SQR2.push(_+t),this._PIECE_SQR1[_+t]=8*(t-1)+("A"==_?0:"B"==_?1:"C"==_?2:"D"==_?3:"E"==_?4:"F"==_?5:"G"==_?6:7)})),this._PIECE_SQR2=this._PIECE_SQR2.sort((t,_)=>t[1]-_[1])}_END_LOOP(t){let _=8-t[1],s=this._SQR_H.findIndex(_=>_==t[0]);return{B:t[0]+1,T:t[0]+8,L:"A"+t[1],R:"H"+t[1],W:s<_?"A"+(parseInt(t[1])+s):this._SQR_H[s-_]+"8",X:7-s<_?"H"+(parseInt(t[1])+(7-s)):this._SQR_H[s+_]+"8",Y:s<t[1]-1?"A"+(t[1]-s):this._SQR_H[s-(t[1]-1)]+"1",Z:7-s<t[1]-1?"H"+(t[1]-(7-s)):this._SQR_H[s+(t[1]-1)]+"1"}}_EVAL_PATTERN(t,_,s=null,i=!0,h=!1){i&&(this._POS={V:[],C:[],K:[],Q:[]});let E=this._END_LOOP(_);return t.split("=").forEach(t=>{let i=void 0===(t=t.split(","))[1]?8:t[1],e="P"==s&&("T"==t[0]||"B"==t[0]),C=this._PIECE_SQR1[E[t[0]]],P=this._PIECE_SQR1[_],r="P"==s&&"T"!=t[0]&&"B"!=t[0],n="N"==s,R=this._M_JUMP[t[0]];if(P!=C)for(let t=0;t<i;t++){P+=R;let t=this._G_PIECE(this._PIECE_SQR2[P]);if(null!=t&&!n||r||this._POS.V.push(this._PIECE_SQR2[P]),t&&!e&&this._COLOR!=t.C&&this._POS.C.push(this._PIECE_SQR2[P]),h&&t&&"K"==t.P&&this._COLOR==t.C){if(this._POS.V.push(this._PIECE_SQR2[P]),P!=C)continue;break}if(P==C||t&&!n)break}if("P"!=s||"X"!=t[0]&&"Z"!=t[0])"N"==s&&(2==this._POS.V.length&&this._N_MOVES.push([t[0],this._POS.V[1]]),this._POS={V:[],C:[],K:[],Q:[]},"R"==t[0]&&this._N_MOVES.length>0&&(this._N_MOVES.forEach(t=>this._EVAL_PATTERN("L"==t[0]||"R"==t[0]?"T,1=B,1":"L,1=R,1",t[1],null,!1)),this._N_MOVES=[]));else{let s="X"==t[0]?["A2","B2","C2","D2","E2","F2","G2","H2"]:["A7","B7","C7","D7","E7","F7","G7","H7"],i="X"==t[0]?["A8","B8","C8","D8","E8","F8","G8","H8"]:["A1","B1","C1","D1","E1","F1","G1","H1"];this._POS.V.splice(s.some(t=>_==t)?2:1),this._POS.V.concat(this._POS.C).some(t=>i.includes(t))&&(this._POS.P=[])}}),this._POS}_GET_DIRECTION(t,_){if(t[0]==_[0])return t[1]>_[1]?"T":"B";if(t[1]==_[1])return t[0]>_[0]?"R":"L";let s=this._END_LOOP(_);return((t=this._PIECE_SQR1[t])-(_=this._PIECE_SQR1[_]))%7==0&&t<=this._PIECE_SQR1[s.W]&&t>=this._PIECE_SQR1[s.Z]?t>_?"W":"Z":(t-_)%9==0&&t<=this._PIECE_SQR1[s.X]&&t>=this._PIECE_SQR1[s.Y]?t>_?"X":"Y":void 0}_IS_VALID(t){for(let _=0;_<t.length;_++)if(null!=this._G_PIECE(t[_])||this.isKingUnsafe(t[_],this._COLOR).length>0)return!1;return!0}_SET_PATTERN(t,_,s,i=!1){if(this._COLOR=s,"K"==t){let t=this._EVAL_PATTERN(this._PATTERN.K,_),s={V:[],C:[],K:[],Q:[]},i="W"==this._COLOR;for(let _ in t)t[_].forEach(t=>0==this.isKingUnsafe(t,this._COLOR).length&&s[_].push(t));if("N"!=this._CASTLE&&(i&&"E1"==_||i&&"E8"==_)&&0==this.isKingUnsafe(_,this._COLOR).length){let t={R1:i?"A1":"A8",R2:i?"H1":"H8"};for(let _ in t)if(null==(_=this._G_PIECE(t[_]))||"R"!=_.P)return s;"B"!=this._CASTLE&&"Q"!=this._CASTLE||!this._IS_VALID(i?["B1","C1","D1"]:["B8","C8","D8"])||(s.Q=i?["C1","D1"]:["C8","D8"],s.V.push(i?"C1":"C8")),"B"!=this._CASTLE&&"K"!=this._CASTLE||!this._IS_VALID(i?["F1","G1"]:["F8","G8"])||(s.K=i?["G1","F1"]:["G8","F8"],s.V.push(i?"G1":"G8"))}return s}return this._EVAL_PATTERN(this._PATTERN["P"==t?"W"==s?"BP":"TP":t],_,t,!0,i)}_CAN_MOVE(t,_,s){if(t.length>1)return!1;if(_=_.V.concat(_.C),["N","P"].some(_=>_==this._G_PIECE(t[0]).P))return!!_.some(_=>_==t[0])&&t;let i=[],h=this._EVAL_PATTERN(this._GET_DIRECTION(t[0],s),s);return h.V.concat(h.C).some(t=>_.includes(t)&&i.push(t)),0!=i.length&&i}_CAN_KILL(t,_){if(["L","R","T","B"].some(_=>_==t)){if(["R","Q"].some(t=>t==_.P))return!0}else if(["B","Q"].some(t=>t==_.P))return!0;return!1}move(t,_,s,i){let h,E,e=this._G_PIECE(t),C={V:[],C:[],K:[],Q:[]};if(null==e)return C;this._CASTLE=["B","N","R","L"].some(t=>t==i)?i:"B";let P=this._SET_PATTERN(e.P,t,e.C);if("K"==e.P)return P;if(s.length>0&&(E=this._CAN_MOVE(s,P,_)),0==E)return C;if(null!=E)return E.forEach(t=>{P.V.includes(t)&&C.V.push(t),P.C.includes(t)&&C.C.push(t)}),C;if(h=this._GET_DIRECTION(t,_)){let s=this._EVAL_PATTERN(h,t,null,!0,!0);if(0==s.C.length||!s.V.some(t=>t==_))return P;if(this._CAN_KILL(h,this._G_PIECE(s.C[0]))){for(let t in P)P[t].forEach(_=>{(s.V.includes(_)||s.C.includes(_))&&C[t].push(_)});return C}}return P}isKingUnsafe(t,_){let s=[];return["Q","P","N"].forEach(i=>{this._SET_PATTERN(i,t,_,"Q"==i).C.forEach(_=>{let h=this._G_PIECE(_).P;"Q"==i?[-7,-9,-8,-1,1,8,9,7].some(s=>s+this._PIECE_SQR1[t]==this._PIECE_SQR1[_])&&"K"==h?s.push(_):["W","X","Y","Z"].some(s=>this._GET_DIRECTION(_,t)==s)?["Q","B"].some(t=>t==h)&&s.push(_):["Q","R"].some(t=>t==h)&&s.push(_):h==i&&s.push(_)})}),s}}
